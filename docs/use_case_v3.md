## Акторы системы:

1.Рентгенолог - основной пользователь. Врач-специалист, который: анализирует снимки с помощью AI, редактирует и подтверждает заключение. Работает с историей пациента.

2.Лечащий врач - врач, направляющий пациента на исследование, который: получает готовые заключения, может просматривать историю исследования, использует данные для постановки диагноза.

3.Администратор системы - технический специалист, который: настраивает параметры AI модели, управляет пользователями и правами доступа, проводит мониторинг работы системы.

4.LLM-сервис - внешняя AI система, которая: анализирует медицинские изображения и генерирует текстовое описание, обеспечивает медицинскую экспертизу.

5.Система PACS - медицинская система архивации, которая хранит историю рентгеновских снимков пациентов, предоставляет доступ к предыдущим исследованиям, интегрируется с медицинской информационной системой.

---

# Use-cases Narrative — Система описания рентгеновских снимков с помощью LLM

---

## UC1 — Регистрация  
**Акторы**: Рентгенолог, Лечащий врач  
**Предусловия**: Актор ещё не зарегистрирован в системе  

### Основной сценарий (Happy Path):
1. Актор предоставляет данные для создания учётной записи (email, пароль, имя)  
2. Система проверяет корректность и уникальность введённых данных  
3. Система создаёт новый аккаунт  
4. Система автоматически авторизует актора и перенаправляет его на главный экран  

**Постусловия**: Создан новый аккаунт; актор авторизован  
**Ценность**: Быстрый и безопасный процесс создания нового аккаунта  

### Альтернативные сценарии:
- **A1. Введены некорректные данные** (неверный формат email, слабый пароль)  
  → Система сообщает об ошибке и предлагает повторить ввод  

### Ошибки:
- **E1. Технический сбой при создании аккаунта**  
  **Обработка**: Система отображает сообщение *«Внутренняя ошибка сервера. Пожалуйста, попробуйте еще раз.»* и возвращает актора на форму регистрации  
- **E2. Аккаунт с таким email уже существует**  
  **Обработка**: Система проверяет уникальность email и отображает сообщение *«Пользователь с таким email уже зарегистрирован»*, предлагая восстановить пароль или использовать другой email  
- **Ценность ошибок**: Предотвращение дублирования аккаунтов и четкие инструкции для актора  

---

## UC2 — Вход в систему  
**Акторы**: Рентгенолог, Лечащий врач, Администратор системы  
**Предусловия**: Актор зарегистрирован  

### Основной сценарий (Happy Path):
1. Актор вводит свои учётные данные (email и пароль)  
2. Система проверяет корректность данных  
3. Система предоставляет актору доступ к функционалу, перенаправляя на главный экран  

**Постусловия**: Актор авторизован  
**Ценность**: Быстрый и безопасный доступ к персональному функционалу приложения  

### Альтернативные сценарии:
- **A1. Введены неверные данные**  
  → Система сообщает об ошибке *«Неверный email или пароль»* и предлагает ввести данные повторно или создать новый аккаунт  

### Ошибки:
- **E1. Сервис аутентификации недоступен**  
  **Обработка**: Система отображает сообщение *«Сервис временно недоступен. Проверьте подключение к интернету и попробуйте снова»*  
- **Ценность**: Актор понимает, что проблема временная и связана не с его данными, а с соединением или сервером  

---

## UC3 — Получение сгенерированного заключения  
**Акторы**: Рентгенолог (основной), Система (LLM-сервис)  
**Предусловия**: Рентгенолог авторизован в системе  

### Основной сценарий (Happy Path):
1. Рентгенолог загружает рентгеновский снимок пациента и текстовый запрос в систему  
2. Система отправляет снимок в LLM-сервис для анализа  
3. LLM-сервис анализирует снимок, выявляет патологии и аномалии  
4. LLM-сервис генерирует структурированное описание с указанием:  
   - качества снимка,  
   - выявленных патологий,  
   - локализации изменений,  
   - рекомендаций для дообследования пациента  
5. Система сохраняет результат как черновик заключения  
6. Рентгенолог проверяет и подтверждает сгенерированное описание  
7. Система сохраняет заключение и интегрирует его в архив пациента  

**Постусловия**: Сгенерировано медицинское заключение; заключение сохранено в системе  
**Ценность**:
- Снижение ошибок рентгенолога, неизбежно случающихся при высокой загруженности  
- Экономия времени пациента и обслуживающего персонала  
- Автоматизация рутинных задач  

### Альтернативные сценарии:
- **A1. Нет интернет-соединения (LLM-сервис недоступен)**  
  Рентгенолог получает уведомление о недоступности сервиса и может:  
  1. Повторить отправку  
  2. Отменить анализ  
  3. Обратиться к администратору системы  
  4. Провести описание самостоятельно (без помощи AI)  
- **A2. Некорректный ввод или неверный формат снимка**  
  Система выводит сообщение *«Не удалось обработать файл. Выберите снимок в формате DICOM, PNG или JPG»* и предлагает повторно выбрать файл  

### Ошибки:
- **E1. Неподдерживаемый формат файла**  
  **Обработка**: Система блокирует загрузку, показывает сообщение: *«Поддерживаются только форматы DICOM, PNG, JPG»*  
  **Ценность**: Предотвращение загрузки некорректных данных, экономия времени, снижение нагрузки на систему  
- **E2. Превышение размера файла (более 15 МБ)**  
  **Обработка**: Система блокирует операцию и выводит сообщение *«Прикрепляемый файл не может быть более 15 МБ. Попробуйте уменьшить размер изображения.»*  
  **Ценность**: Защита системы от перегрузки, предотвращение замедления работы, экономия сетевого трафика и хранилища  

---

## UC4 — Редактирование сгенерированного медицинского заключения  
**Акторы**: Рентгенолог  
**Предусловия**: Сгенерировано медицинское заключение; создан черновик заключения  

### Основной сценарий (Happy Path):
1. Рентгенолог просматривает сгенерированное медицинское заключение  
2. Рентгенолог соглашается с сгенерированным медицинским заключением и добавляет профессиональные комментарии  
3. Рентгенолог сохраняет отредактированную версию как финальное заключение  

**Постусловия**: Заключение отредактировано и сохранено  
**Ценность**:
- Снижение ошибок в финальном медицинском заключении  
- Возможность дообучения искусственного интеллекта на основе правок специалиста  

### Альтернативные сценарии:
- **A1. Рентгенолог частично правит AI-заключение**  
  Рентгенолог корректирует терминологию и формулировки, добавляет профессиональные комментарии и наблюдения, уточняет локализацию и характеристику находок. Система сохраняет доработанное медицинское заключение как финальное  
- **A2. Рентгенолог отклоняет AI-заключение полностью**  
  Рентгенолог удаляет AI-описание и составляет заключение полностью вручную. Система сохраняет исправленное медицинское заключение как финальное  

### Ошибки:
- **E1. Потеря данных при редактировании**  
  **Обработка**: Система автоматически сохраняет черновики каждые 30 секунд, предлагает восстановить последнюю сохранённую версию  
  **Ценность**: Защита от случайной потери важных медицинских данных, снижение стресса пользователя, повышение надёжности системы  
- **E2. Конфликт версий (если заключение уже подтверждено)**  
  **Обработка**: Система предупреждает: *«Заключение уже утверждено. Для изменений требуется создать новую версию»*  
  **Ценность**: Предотвращение несанкционированного изменения утверждённых документов, поддержка аудита изменений, юридическая защищённость данных  

---

## UC5 — Сравнение с предыдущими снимками пациента  
**Акторы**: Рентгенолог (основной), Система (LLM-сервис), Система PACS  
**Предусловия**: У пациента есть предыдущие исследования в системе PACS  

### Основной сценарий (Happy Path):
1. Рентгенолог запрашивает сравнение текущего снимка с предыдущими  
2. Система автоматически загружает архивные снимки из PACS  
3. LLM-сервис анализирует изменения  
4. LLM-сервис генерирует сравнительный отчёт с указанием:  
   - прогрессирования патологии,  
   - появления новых находок,  
   - положительной динамики лечения  
5. Рентгенолог использует отчёт для составления финального медицинского заключения  

**Постусловия**: Сравнительный анализ выполнен; отчёт доступен  
**Ценность**:
- Анализ динамики лечения пациента  
- Корректировка методики лечения на основе объективных данных  

### Альтернативные сценарии:
- **A1. Предыдущих снимков нет в PACS**  
  Система уведомляет: *«Архивные снимки не найдены»*, предлагает продолжить без сравнения  
- **A2. Несколько предыдущих исследований**  
  Рентгенолог выбирает, с каким именно снимком сравнить текущий (последний, самый старый, по дате)  

### Ошибки:
- **E1. PACS недоступен**  
  **Обработка**: Система сохраняет запрос локально и повторяет попытку при восстановлении соединения  
  **Ценность**: Работа системы не прерывается при временных сбоях внешних систем, данные не теряются, прозрачность процесса для пользователя  
- **E2. Не найдена история болезни пациента в системе PACS**  
  **Обработка**: Система предлагает выбрать пациента в базе данных вручную  
  **Ценность**: Предотвращение ошибок потери истории болезни пациента, возможность ручного поиска пациента  

---

## UC6 — Настройка и калибровка AI-модели  
**Акторы**: Администратор системы  
**Предусловия**: Администратор имеет права на настройку системы  

### Основной сценарий (Happy Path):
1. Администратор анализирует текущую производительность системы  
2. Администратор калибрует медицинскую терминологию  
3. Администратор оптимизирует параметры AI-модели  
4. Администратор управляет обучающими данными  
5. Администратор проводит тестирование и валидацию модели  

**Постусловия**: AI-модель настроена и готова к использованию  
**Ценность**:
- Снижение ошибок AI-модели  
- Ускорение обработки снимков и генерации заключений  

### Альтернативные сценарии:
- **A1. Автоматическая калибровка**  
  Администратор запускает автоматический режим калибровки на основе последних данных  
- **A2. Откат к предыдущей версии модели**  
  При неудачной калибровке администратор может восстановить предыдущую рабочую версию модели  

### Ошибки:
- **E1. Недостаточно данных для калибровки**  
  **Обработка**: Система требует загрузки дополнительных размеченных данных  
  **Ценность**: Предотвращение некорректной калибровки на малом наборе данных, повышение качества модели, снижение риска ошибок ИИ в будущем  
- **E2. Конфликт параметров модели**  
  **Обработка**: Система проверяет корректность введённых параметров и предлагает значения по умолчанию  
  **Ценность**: Защита от некорректных настроек, предотвращение сбоев модели, помощь администратору в принятии правильных решений  

---

## UC7 — Интегрирование медицинского заключения в цифровой архив пациента  
**Акторы**: Рентгенолог (инициирует), Система PACS  
**Предусловия**: Финальное медицинское заключение готово  

### Основной сценарий (Happy Path):
1. Рентгенолог находит историю болезни пациента в системе PACS с помощью личных данных пациента  
2. Рентгенолог добавляет финальное медицинское заключение в существующий архив пациента  
3. Система PACS сохраняет финальное медицинское заключение пациента  

**Постусловия**: Данные сохранены в цифровом архиве пациента  
**Ценность**:
- Цифровизация медицинских архивов  
- Ускорение поиска истории болезни пациента  

### Альтернативные сценарии:
- **A1. Пациент не найден в системе PACS**  
  Система создаёт новую историю болезни для пациента  

### Ошибки:
- **E1. Недостаточно места в архиве PACS**  
  **Обработка**: Система уведомляет администратора, предлагает очистить старые данные или расширить хранилище  
  **Ценность**: Предотвращение потери важных медицинских данных, проактивное управление ресурсами, снижение риска сбоев системы  
- **E2. Ошибка синхронизации с PACS**  
  **Обработка**: Система сохраняет данные локально, помечает их для повторной отправки, уведомляет администратора  
  **Ценность**: Обеспечение целостности данных, возможность отложенной синхронизации, снижение зависимости от внешних систем  

---

## UC8 — Использование медицинского заключения для постановки диагноза  
**Акторы**: Лечащий врач  
**Предусловия**: Заключение рентгенолога готово и сохранено в системе PACS  

### Основной сценарий (Happy Path):
1. Лечащий врач запрашивает доступ к заключениям пациента из системы PACS  
2. Лечащий врач анализирует финальное медицинское заключение рентгенолога  
3. Лечащий врач проводит интеграцию с клинической картиной (сопоставляет жалобы пациента с остальными результатами исследования)  
4. Лечащий врач ставит диагноз и планирует лечение  

**Постусловия**: Диагноз поставлен; план лечения составлен  
**Ценность**:
- Повышение качества лечения и снижение диагностических ошибок  
- Экономия времени лечащего врача на постановку диагноза  

### Альтернативные сценарии:
- **A1. Заключение требует уточнения у врачебной комиссии**  
  Лечащий врач собирает консилиум врачей для постановки диагноза и плана лечения пациента  
- **A2. Диагноз не может быть поставлен на основе одного заключения**  
  Врач назначает дополнительные исследования и откладывает постановку диагноза  

### Ошибки:
- **E1. Нет доступа к заключению пациента**  
  **Обработка**: Система сообщает: *«У вас нет прав для просмотра этого заключения»*, предлагает запросить доступ  
  **Ценность**: Обеспечение конфиденциальности медицинских данных, предотвращение несанкционированного доступа  
- **E2. Заключение не найдено или удалено**  
  **Обработка**: Система показывает сообщение: *«Заключение недоступно. Обратитесь в архив или к рентгенологу»*  
  **Ценность**: Предотвращение использования устаревших или удалённых данных, направление врача к правильному источнику информации, поддержка аудита доступа  

---

## Happy Path для основного сценария «Автоматическое описание рентгеновского снимка».

1.Рентгенолог загружает рентгеновский снимок

1.1. Рентгенолог авторизуется в системе под своим именем.

1.2. Рентгенолог переходит в раздел анализа снимков.

1.3. Рентгенолог нажимает на кнопку «Загрузить снимок».

1.4. Рентгенолог выбирает файл снимка пациента в разрешении Dicom, PNG, JPG.

1.5. Рентгенолог вводит текстовый запрос.

1.6. Рентгенолог нажимает кнопку «Анализировать снимок».

2.Система отправляет рентгеновский снимок и текстовый запрос в LLM-сервис для анализа.

3.LLM-сервис анализирует запрос

3.1. LLM-сервис выполняет компьютерный анализ анатомических структур.

3.2. LLM-сервис обнаруживает патологические признаки и аномалии.

3.3. LLM-сервис определяет локализацию и характеристики выявленных изменений.

3.4. LLM-сервис генерирует структурированное медицинское описание, включая: выявленные патологии, локализацию, изменения, оценку тяжести, рекомендации.

4.Система принимает и сохраняет AI-результат.

4.1. Система получает ответ от LLM-сервиса.

4.2. Система проверяет структуру ответа.

4.3. Система создаёт черновик заключения.

4.4. Система сохраняет полученный результат от LLM-сервиса в локальную базу данных.

5.Система отображает результат рентгенологу.

5.1. Рентгенологу открывается экран со снимком.

5.2. Система показывает сгенерированное AI-заключение на экране рентгенологу.

6.Рентгенолог подтверждает заключение LLM-сервиса.

6.1. Рентгенолог проверяет вывод AI.

6.2. Рентгенолог соглашается с исследованием системы.

6.3. Рентгенолог нажимает на флажок “AI-заключение готово и не требует исправлений”.

6.4. Рентгенолог нажимает кнопку «Подтвердить заключение».

6.5. Система фиксирует заключение как финальное.

7.Интеграция в цифровой архив пациента.

7.1. Система определяет пациента по идентификатору исследования.

7.2. Система добавляет снимок и итоговое заключение в историю пациента.

7.3. Система обновляет электронный архив PACS.

---

## Альтернативный сценарий 1: Нет интернет соединения (LLM-сервис недоступен)

Точка отклонения от основного сценария:

После шага «Система отправляет рентгеновский снимок и текстовый запрос в LLM-сервис для анализа».

Шаги:

1.Система отправляет запрос на анализ, но не получает ответ от LLM-сервиса в установленные сроки (таймаут).

2.Система фиксирует ошибку уровня сети или недоступность удалённого сервиса.

3.Система отображает рентгенологу сообщение:

”Не удалось выполнить анализ. LLM-сервис временно недоступен. Попробуйте позже.”

4.Рентгенолог может выбрать:

4.1.Повторить отправку,

4.2.Оменить анализ,

4.3.Позвать администратора системы,

4.4.Провести анализ самостоятельно (без помощи AI).

5.Рентгенолог нажимает на кнопку “Провести анализ вручную”.

6.Система открывает форму ручного описания снимка:

6.1.Рентгенолог заполняет поле «Находки»,

6.2.Рентгенолог заполняет поле «Локализация»,

6.3.Рентгенолог заполняет поле «Заключение»,

6.4.Рентгенолог заполняет поле «Рекомендации».

7.Рентгенолог сохраняет медицинское заключение, нажав на кнопку “Сохранить”.

8.Система сохраняет вручную введённое описание как финальное заключение.

9.Система добавляет запись в локальный архив.

Результат альтернативного сценария: Система дала несколько вариантов для решения проблемы рентгенологу: повторить отправку снимка в LLM-сервис, отменить анализ или провести анализ самостоятельно.

---

## Альтернативный сценарий 2: Нет интернет соединения (Электронный архив PACS недоступен)

Точка отклонения от основного сценария:

После шага “Система определяет пациента по идентификатору исследования.”

Шаги:

1.Система обнаруживает отсутствие интернет-соединения.

2.Система отправляет данные в локальную SQLite базу.

3.Запись получает статус “Pending Sync” - “ожидает синхронизации”.

4.Система проверяет очередь локальных “незагруженных” заключений.

5.Когда интернет соединение восстанавливается, “незагруженные” исследования система отправляет по очереди в архив PACS.

Результат альтернативного сценария: Система сохранила медицинское заключение в локальной базе данных. После восстановления соединения с электронным архивом PACS система отправит исследование в глобальное хранилище.

---

## Альтернативный сценарий 3: Некорректный ввод или неверный формат снимка

Ошибка валидации входных данных

Точка отклонения:

После шага «Рентгенолог выбирает файл снимка пациента».

Шаги:

1.Рентгенолог выбирает файл, но система обнаруживает: неподдерживаемый формат (например PDF), повреждённый файл, некорректные метаданные.

2.Система блокирует дальнейший анализ.

3.Система выводит сообщение “Не удалось обработать файл. Выберите снимок в формате DICOM, PNG или JPG”.

4.Система предлагает повторно выбрать файл.

5.Рентгенолог загружает корректный снимок.

6.Процесс возвращается в основной Happy Path.

Результат альтернативного сценария: Обработка не начата, система предотвращает ошибочный анализ и позволяет загрузить правильный снимок.

---

## Ошибка 1: Технический сбой / Internal Server Error 

1.Лечащий врач запрашивает медицинское заключение по пациенту.

2.Система PACS не отправляет ответ на запрос.

3.Система отображает сообщение: "Произошла техническая ошибка. Повторите позже."

4.Лечащий врач может повторить операцию без потери сессии.

5.Лечащий врач просит администратора системы решить проблему.

---

## Ошибка 2: Некорректная аутентификация пользователя

1.Пользователь вводит неправильные данные своего аккаунта (логин, пароль).

2.Система уведомляет пользователя, что аккаунта с такими данными не найдено.

3.Пользователь исправляет ошибку и повторяет вход в систему.

---

## Ошибка 3: Превышение размера загружаемого файла

1.Пользователь загружает файл более 15МБ.

2.Система блокирует операцию.

3.Показывается сообщение: "Прикрепляемый файл не может быть более 15МБ. Попробуйте уменьшить размер изображения."
